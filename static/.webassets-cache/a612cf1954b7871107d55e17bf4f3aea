V"use strict";$(function(){$(document).on("change","#install-mod input[type='file']",function(){var $this=$(this);var $btn=$('#install-mod-button');var file=this.files[0];$btn.removeClass('btn-default').addClass('btn-success disabled');$btn.html("<i class='fa fa-refresh fa-spin'></i> "+$BABEL_STR_INSTALLING+" '"+file.name+"'...");bootbox.dialog({message:"<div class='text-center text-muted'><h1><i class='fa fa-circle-o-notch fa-spin'></i><br/>"+$BABEL_STR_PLEASE_WAIT+"</h1></div>",buttons:{}});$('#install-mod #url').val('');$('#install-mod').submit();});$(document).on("change","#upload-maps input[type='file']",function(){var $this=$(this);var $btn=$('#btn-upload-map');var srvid=$('#form-server-config #srvid').val();var file=this.files[0];var origHTML=$btn.html();$btn.removeClass('btn-default').addClass('btn-success disabled');$btn.html("<i class='fa fa-refresh fa-spin'></i> "+$BABEL_STR_UPLOADING+" '"+file.name+"'...");$.ajax({url:'/_upload_maps/'+srvid,type:'POST',data:new FormData($('#upload-maps')[0]),contentType:false,cache:false,processData:false,async:false,success:function(data){check_server_data(data);if(data['success'])\u000a{refresh_server_maps_list(srvid);if(".map"===file.name.substr(-4))\u000a{var $line=$("tr#row-"+file.name.substr(0,file.name.length-4));var $list=$("#maplist-container");$list.animate({scrollTop:$line.offset.top-$list.offset.top+$list.scrollTop()});}}\u000a$btn.removeClass('btn-default').removeClass('btn-success disabled').addClass('btn-default');$btn.html(origHTML);},error:function(){check_server_data({'error':true,'errormsg':$BABEL_STR_UNEXPECTED_ERROR});$btn.removeClass('btn-default').removeClass('btn-success disabled').addClass('btn-default');$btn.html(origHTML);}});});$(document).on("click","#install-mod-url",function(){bootbox.prompt($BABEL_STR_URL_TO_PACKAGE,function(result){if(result!==null){var $btn=$('#install-mod-button');$btn.removeClass('btn-default').addClass('btn-success disabled');$btn.html("<i class='fa fa-refresh fa-spin'></i> "+$BABEL_STR_INSTALLING);bootbox.dialog({message:"<div class='text-center text-muted'><h1><i class='fa fa-circle-o-notch fa-spin'></i><br/>"+$BABEL_STR_PLEASE_WAIT+"</h1></div>",buttons:{}});$('#install-mod #url').val(result);$('#install-mod').submit();}});});$(document).on("click","a[data-target='#modal_new_server']",function(){var mod=$(this).data('mod');$('#modal_new_server #mod').val(mod);var $cfglist=$('#modal_new_server #configs');$cfglist.children().remove();$('#modal_new_server #cfgfile').val("");$.post($SCRIPT_ROOT+'/_get_mod_configs/'+mod,'',function(data){if(data['configs']&&data['configs'].length>0)\u000a{$('#modal_new_server #cfgfile').val(data['configs'][0]);for(i in data['configs'])\u000a$cfglist.append("<option value='"+data['configs'][i]+"'>"+data['configs'][i]+"</option>");}});});$(document).on("click","#modal_new_server .btn-success",function(){var srvmod=$('#modal_new_server #mod').val();var configfile=$(".modal-body #cfgfile").val();if(!configfile)\u000areturn;$.post($SCRIPT_ROOT+'/_create_server_instance/'+srvmod,'fileconfig='+configfile,function(data){check_server_data(data);if(data['success'])\u000a{$('#modal_new_server').modal('hide');window.location.reload();}});});$(document).on("click",".remove-server-instance",function(){var srvid=$(this).data('id');var srvmod=$(this).data('mod');bootbox.dialog({message:$BABEL_STR_ARE_YOU_SURE+"<br/><input type='checkbox' name='delete-configfile'/>"+$BABEL_STR_DELETE_CONF,title:$BABEL_STR_DELETE+" '"+srvmod+"' "+$BABEL_STR_SERVER_INSTANCE,buttons:{success:{label:$BABEL_STR_DELETE,className:"btn-danger",callback:function(){var delconfig=$("input[name='delete-configfile']:checked").val()==='on'?'1':'0';$.post($SCRIPT_ROOT+'/_remove_server_instance/'+srvid+'/'+delconfig,'',function(data){check_server_data(data);if(data['success'])\u000a{window.location.reload();}});}},main:{label:$BABEL_STR_CANCEL,className:"btn-default"}}});});$(document).on("click","a[data-target='#modal_external_console']",function(){var srvid=$(this).data('id');$("#modal_external_console #srvid").val(srvid);$("#modal_external_console #econ-log").val('');setTimeout("$('#modal_external_console #cmd').focus()",150);});$(document).on("click","#modal_external_console #send-econ-command",function(){var $this=$(this);var srvid=$this.data('id');if($this.hasClass('disabled'))\u000areturn;$this.addClass('disabled').html("<i class='fa fa-spinner fa-spin'></i> "+$BABEL_STR_SENDING);$.post($SCRIPT_ROOT+'/_send_econ_command/'+$('#form-econ #srvid').val(),$('#form-econ').serialize(),function(data){$this.removeClass('disabled').text("Send");check_server_data(data);if(data['success'])\u000a{$("#modal_external_console #cmd").val('');var $econlog=$("#modal_external_console #econ-log");var last_content=$econlog.val();$econlog.val(last_content+data['rcv']);$econlog.prop('scrollTop',$econlog.prop('scrollHeight'));$('#modal_external_console #cmd').focus();}});});$(document).on("click",".menu-item-server-bin",function(){var $this=$(this);var $parent_ul=$this.parent().parent();var srvid=$parent_ul.data('id');var srvbin=$this.text().trim();$.post($SCRIPT_ROOT+'/_set_server_binary/'+srvid+'/'+srvbin,'',function(data){check_server_data(data);if(data['success'])\u000a{$parent_ul.find('li').removeClass('active');$this.parent().addClass('active');$('#btn-play-srv-'+srvid+' .start-instance').removeClass('disabled');}});});$('#modal_instance_configuration').modal({'backdrop':'static','show':false});$(document).on("click","a[data-target='#modal_instance_configuration']",function(){var srvid=$(this).data('id');$('#form-server-config #srvid').val(srvid);$.post($SCRIPT_ROOT+'/_get_server_config/'+srvid,'',function(data){check_server_data(data);if(data['success'])\u000a{$("#modal_instance_configuration #check_alsrv").prop('checked',data['alsrv']);$("#modal_instance_configuration #srvcfg").val(data['srvcfg']);$("#modal_instance_configuration .modal-title").text("Instance Configuration: "+data['fileconfig']);}\u000aelse\u000a{$("#modal_instance_configuration #check_alsrv").prop('checked',false);$("#modal_instance_configuration #srvcfg").val("");$("#modal_instance_configuration .modal-title").text($BABEL_STR_INSTANCE_CONF);}});});$(document).on("change",".check_map",function(){update_advance_config_maps();});$(document).on("click",".remove-map",function(){var map=$(this).data("map");var srvid=$('#form-server-config #srvid').val();$.post($SCRIPT_ROOT+'/_remove_map/'+srvid,'map='+map,function(data){check_server_data(data);if(data['success'])\u000a{$("tr#row-"+map).remove();update_advance_config_maps();}});});$(document).on("change",".wizard-param",function(){var $this=$(this);var value=$this.val();var defval=$this.data('default')==='undefined'?undefined:$this.data('default');if($this.is("input")&&"checkbox"===$this.prop("type"))\u000avalue=$this.prop('checked')?1:0;update_config_textarea($("#modal_instance_configuration #srvcfg"),$this.attr("id"),value,defval);});$(document).on("change","#check_alsrv",function(){$("#modal_instance_configuration #alsrv").val($(this).is(":checked"));});$("ul.nav-tabs > li > a").on("shown.bs.tab",function(e){var id=$(e.target).attr("href").substr(1);var srvid=$('#form-server-config #srvid').val();if("maps"===id)\u000arefresh_server_maps_list(srvid);else if("wizard"===id)\u000agenerate_wizard($('#wizard'),srvid);});$(document).on("click","#modal_instance_configuration .btn-success",function(){var $this=$(this);$.post($SCRIPT_ROOT+'/_save_server_config/'+$("#form-server-config #srvid").val(),$('#form-server-config').serialize(),function(data){check_server_data(data);if(data['success'])\u000a{var srvline_id='#srv-line-'+data['id'];var $port=$(srvline_id+' .srv-port');var $name=$(srvline_id+' .srv-name');var $gametype=$(srvline_id+' .srv-gametype');var $flags=$(srvline_id+' .srv-flags');$port.text(data['port']);$name.text(data['name']);$gametype.text(data['gametype']);if(data['visible']==0)\u000a$flags.find('.tw-no-register').addClass('fa-eye').removeClass('fa-eye-slash').css('color','#333').prop('title',$BABEL_STR_PRIVATE_SERVER);else\u000a$flags.find('.tw-no-register').addClass('fa-eye-slash').removeClass('fa-eye').css('color','#BBB').prop('title',$BABEL_STR_PUBLIC_SERVER);if(data['public']==0)\u000a$flags.find('.tw-password').css('color','#333').prop('title',$BABEL_STR_REGISTER_SERVER);else\u000a$flags.find('.tw-password').css('color','#BBB').prop('title',$BABEL_STR_NOT_REGISTER_SERVER);$('#modal_instance_configuration').modal('hide');if(data['status'])\u000a{bootbox.dialog({message:$BABEL_STR_SERVER_ONLINE,title:$BABEL_STR_RESTART_SERVER,buttons:{success:{label:$BABEL_STR_RESTART,className:"btn-danger",callback:function(){$.post($SCRIPT_ROOT+'/_restart_server_instance/'+data['id'],'',function(data){check_server_data(data);if(data['success'])\u000awindow.location.href='/servers';});}},main:{label:$BABEL_STR_OK,className:"btn-default"}}});}}});});$(document).on("click",".start-instance",function(){var $this=$(this);var srvid=$this.data('id');var $listline=$('#srv-line-'+srvid);var $btngroup=$('#btn-play-srv-'+srvid);var $btnlist=$btngroup.find('.dropdown-toggle');$this.addClass('disabled btn-warning').removeClass('btn-success');$btnlist.addClass('disabled btn-warning').removeClass('btn-success');$listline.find("a[data-target='#modal_instance_configuration']").addClass('disabled hidden');$listline.find(".remove-server-instance").addClass('disabled');$this.html("<i class='fa fa-spinner fa-spin'></i> "+$BABEL_STR_STARTING);$.post($SCRIPT_ROOT+'/_start_server_instance/'+srvid,'',function(data){if(data['error'])\u000a{$this.removeClass('disabled btn-warning').addClass('btn-success');$btnlist.removeClass('disabled btn-warning').addClass('btn-success');$listline.find("a[data-target='#modal_instance_configuration']").removeClass('disabled hidden');$listline.find(".remove-server-instance").removeClass('disabled');$this.html("<i class='fa fa-play'></i> "+$BABEL_STR_START);}\u000acheck_server_data(data);if(data['success'])\u000a{window.location.reload();}});});$(document).on("click",".stop-instance",function(){var srvid=$(this).data('id');$.post($SCRIPT_ROOT+'/_stop_server_instance/'+srvid,'',function(data){check_server_data(data);if(data['success'])\u000a{window.location.reload();}});});$(document).on("click",".remove-mod",function(){var mod_folder=$(this).data('mod');bootbox.dialog({message:$BABEL_STR_ARE_YOU_SURE+"<br/><span class='text-danger'>"+$BABEL_STR_THIS_CANT_BE_CANCELED+"</span>",title:$BABEL_STR_REMOVE+" '"+mod_folder+"' Mod",buttons:{success:{label:$BABEL_STR_REMOVE,className:"btn-danger",callback:function(){$.post($SCRIPT_ROOT+'/_remove_mod','folder='+mod_folder,function(data){check_server_data(data);if(data['success'])\u000a{window.location.reload();}});}},main:{label:$BABEL_STR_CANCEL,className:"btn-default"}}});});});function refresh_server_maps_list(srvid)\u000a{var maps=new Array();var maps_str=get_config_value_textarea($("#modal_instance_configuration #srvcfg"),"sv_maprotation");if(maps_str)\u000amaps=maps_str.split(" ");maps.push(get_config_value_textarea($("#modal_instance_configuration #srvcfg"),"sv_map"));$.post($SCRIPT_ROOT+'/_get_server_maps/'+srvid,'',function(data){check_server_data(data);if(data['success'])\u000a{$("#maplist").html("");for(var i in data['maps'])\u000a{var mapSelected=maps.indexOf(data['maps'][i].name)>=0;var row="<tr id='row-"+data['maps'][i].name+"'>";row+="<td><input type='checkbox' name='map_used' class='check_map' data-map='"+data['maps'][i].name+"' "+(mapSelected?'checked':'')+"/></td>";row+="<td>"+data['maps'][i].name+"</td>";row+="<td>"+data['maps'][i].size+"</td>";row+="<td class='text-right'><a class='remove-map btn btn-xs' data-map='"+data['maps'][i].name+"' href='#' title='"+$BABEL_STR_REMOVE_MAP+"'><i class='fa fa-remove'></i></a></td>";row+="</tr>";$("#maplist").append(row);}}});}\u000afunction generate_wizard($wizard,srvid)\u000a{$.getJSON($SCRIPT_ROOT+'/static/json/base_conf.json',function(data){$.post($SCRIPT_ROOT+'/_get_mod_wizard_config/'+srvid,'',function(mdata){check_server_data(mdata);var mcfg=data;if(mdata['success']&&mdata['config'])\u000a$.extend(true,mcfg,data,$.parseJSON(mdata['config']));var html="";html+="<ul id='simple-tabs' class='nav nav-pills nav-justified' role='tablist'>";$.each(mcfg,function(section,variables){html+="<li><a href='#"+section.replace(" ","_")+"' data-toggle='tab'>"+section+"</a></li>";});html+="</ul>";html+="<div class='tab-content' style='margin-top:1.5em;'>";$.each(mcfg,function(section,variables){html+="<div class='tab-pane' id='"+section.replace(" ","_")+"' style='overflow:auto; height:220px;'>";$.each(variables,function(key,val){var defval=val.default;var rval=get_config_value_textarea($("#modal_instance_configuration #srvcfg"),key);if(!rval)\u000arval=defval;if("select"===val.type)\u000a{html+="<label for='"+key+"'>"+val.label+"</label>";html+="<select id='"+key+"' data-default='"+defval+"' class='form-control wizard-param' title='"+(val.tooltip?val.tooltip:'')+"'>";for(var i in val.values)\u000ahtml+="<option value='"+val.values[i]+"' "+(val.values[i]==rval?'selected':'')+">"+val.values[i]+"</option>";html+="</select>";}\u000aelse if("checkbox"===val.type)\u000a{html+="<input class='wizard-param' data-default='"+defval+"' id='"+key+"' type="+val.type+" title='"+(val.tooltip?val.tooltip:'')+"' "+(1==rval?'checked':'')+"/> <span style='font-weight:bold'>"+val.label+"</span><br/>";}\u000aelse\u000a{html+="<label for='"+key+"'>"+val.label+"</label>";html+="<input id='"+key+"' data-default='"+defval+"' type="+val.type+" value='"+(rval?rval:'')+"' "+(val.range?"min='"+val.range[0]+"' max='"+val.range[1]+"'":'')+" class='form-control wizard-param' title='"+(val.tooltip?val.tooltip:'')+"' />";}});html+="</div>";});html+="</div>";$wizard.html(html);$('#simple-tabs a:first').tab('show');});});}\u000afunction update_advance_config_maps()\u000a{var maps=new Array();$("input[name=map_used]:checked").each(function(){maps.push($(this).data('map'));});update_config_textarea($("#modal_instance_configuration #srvcfg"),"sv_map",(maps.length>0)?maps[0]:undefined);update_config_textarea($("#modal_instance_configuration #srvcfg"),"sv_maprotation",(maps.length>1)?maps.join(" "):undefined);}
p1
.